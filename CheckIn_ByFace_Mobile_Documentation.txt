===============================================================================
                          CHECK-IN BY FACE API DOCUMENTATION
                              FOR MOBILE DEVELOPMENT TEAM
===============================================================================

ðŸ“± API ENDPOINT
==============
- Method: POST
- URL: /api/tickets/checkinbyface
- Content-Type: multipart/form-data
- Authorization: Bearer Token (Required)
- Roles: Admin, EventManager, Collaborator only

ðŸ”‘ AUTHENTICATION
=================
- Header: Authorization: Bearer {access_token}
- Token pháº£i chá»©a AccountId cá»§a ngÆ°á»i thá»±c hiá»‡n check-in
- Chá»‰ Admin, EventManager, vÃ  Collaborator má»›i cÃ³ quyá»n thá»±c hiá»‡n

ðŸ“¥ REQUEST FORMAT
================
Content-Type: multipart/form-data

Required Fields:
- EventId (string): ID cá»§a sá»± kiá»‡n cáº§n check-in
- FaceImage (file): áº¢nh khuÃ´n máº·t cá»§a khÃ¡ch hÃ ng

Example Request (FormData):
{
    "EventId": "67123b123c123d123e123456",
    "FaceImage": [File object - JPG/JPEG/PNG format]
}

ðŸ–¼ï¸ IMAGE REQUIREMENTS
====================
- Formats: JPG, JPEG, PNG only
- Max size: 5MB
- Recommended: Clear facial image, good lighting
- AI sáº½ nháº­n diá»‡n khuÃ´n máº·t vÃ  tÃ¬m OrderId tÆ°Æ¡ng á»©ng

ðŸ“¤ RESPONSE FORMAT
==================
Success Response (200):
{
    "success": true,
    "message": "Face check-in completed successfully",
    "data": {
        "orderId": "order123456",
        "eventId": "event123456", 
        "customerName": "Nguyá»…n VÄƒn A",
        "totalTickets": 5,
        "successfulCheckins": 3,
        "alreadyCheckedIn": 2,
        "checkinDetails": [
            {
                "ticketCode": "QR001",
                "ticketType": "VIP Ticket",
                "status": "success",
                "message": "ticket QR001 checkin success",
                "previousCheckIn": null
            },
            {
                "ticketCode": "QR002", 
                "ticketType": "VIP Ticket",
                "status": "success",
                "message": "ticket QR002 checkin success",
                "previousCheckIn": null
            },
            {
                "ticketCode": "QR003",
                "ticketType": "Standard Ticket", 
                "status": "success",
                "message": "ticket QR003 checkin success",
                "previousCheckIn": null
            },
            {
                "ticketCode": "QR004",
                "ticketType": "Standard Ticket",
                "status": "already_checked_in", 
                "message": "ticket QR004 already checked in at 2024-12-19 14:30 by Tráº§n Thá»‹ B via QrCode",
                "previousCheckIn": {
                    "checkedInAt": "2024-12-19T14:30:15.000Z",
                    "checkedInBy": "user456",
                    "checkerName": "Tráº§n Thá»‹ B", 
                    "checkInMethod": "QrCode"
                }
            },
            {
                "ticketCode": "QR005",
                "ticketType": "Standard Ticket",
                "status": "already_checked_in",
                "message": "ticket QR005 already checked in at 2024-12-19 15:45 by LÃª VÄƒn C via FaceRecognition", 
                "previousCheckIn": {
                    "checkedInAt": "2024-12-19T15:45:22.000Z",
                    "checkedInBy": "user789",
                    "checkerName": "LÃª VÄƒn C",
                    "checkInMethod": "FaceRecognition"
                }
            }
        ]
    }
}

ðŸ“Š RESPONSE FIELDS EXPLANATION
==============================

Root Level:
- orderId: ID cá»§a Ä‘Æ¡n hÃ ng Ä‘Æ°á»£c nháº­n diá»‡n
- eventId: ID sá»± kiá»‡n
- customerName: TÃªn khÃ¡ch hÃ ng sá»Ÿ há»¯u vÃ©
- totalTickets: Tá»•ng sá»‘ vÃ© trong order cho event nÃ y
- successfulCheckins: Sá»‘ vÃ© check-in thÃ nh cÃ´ng láº§n nÃ y
- alreadyCheckedIn: Sá»‘ vÃ© Ä‘Ã£ Ä‘Æ°á»£c check-in trÆ°á»›c Ä‘Ã³

CheckIn Details:
- ticketCode: MÃ£ QR cá»§a vÃ©
- ticketType: Loáº¡i vÃ© (VIP, Standard, etc.)
- status: Tráº¡ng thÃ¡i check-in
  * "success": Check-in thÃ nh cÃ´ng
  * "already_checked_in": VÃ© Ä‘Ã£ Ä‘Æ°á»£c check-in trÆ°á»›c Ä‘Ã³
  * "failed": Check-in tháº¥t báº¡i
- message: ThÃ´ng bÃ¡o chi tiáº¿t
- previousCheckIn: ThÃ´ng tin check-in trÆ°á»›c (náº¿u cÃ³)

Previous CheckIn Info:
- checkedInAt: Thá»i gian check-in trÆ°á»›c (ISO 8601)
- checkedInBy: UserID cá»§a ngÆ°á»i check-in trÆ°á»›c
- checkerName: TÃªn ngÆ°á»i check-in trÆ°á»›c
- checkInMethod: PhÆ°Æ¡ng thá»©c check-in trÆ°á»›c

ðŸš¨ ERROR RESPONSES
==================

1. AUTHENTICATION ERRORS:
{
    "success": false,
    "message": "Invalid token: missing user id"
}

{
    "success": false, 
    "message": "Invalid token: account id is not a valid GUID"
}

2. VALIDATION ERRORS:
{
    "success": false,
    "message": "Invalid request" // ModelState validation failed
}

{
    "success": false,
    "message": "Face image is required"
}

{
    "success": false,
    "message": "Only accept JPG, JPEG or PNG"
}

{
    "success": false,
    "message": "Must smaller than 5MB"
}

3. AI SERVICE ERRORS:
{
    "success": false,
    "message": "Face not recognized for this event"
}

{
    "success": false,
    "message": "AI service not responding" 
}

{
    "success": false,
    "message": "An error occurred while processing the face image"
}

4. BUSINESS LOGIC ERRORS:
{
    "success": false,
    "message": "No tickets found for this order"
}

{
    "success": false,
    "message": "No tickets found for this event in the order"
}

5. SYSTEM ERRORS:
{
    "success": false,
    "message": "An error occurred during face check-in"
}

ðŸ”§ CHECK-IN METHOD ENUM
=======================
CheckInMethod values:
- QrCode = 0
- FaceRecognition = 1  
- Other = 2

âš ï¸ SPECIAL CASES & IMPORTANT NOTES
==================================

1. PARTIAL CHECK-IN SUCCESS:
   - Má»™t order cÃ³ thá»ƒ cÃ³ nhiá»u vÃ© cho cÃ¹ng 1 event
   - CÃ³ thá»ƒ má»™t sá»‘ vÃ© check-in thÃ nh cÃ´ng, má»™t sá»‘ Ä‘Ã£ check-in trÆ°á»›c Ä‘Ã³
   - Response sáº½ chá»©a chi tiáº¿t tá»«ng vÃ© vá»›i status riÃªng biá»‡t
   - successfulCheckins: chá»‰ tÃ­nh vÃ© check-in thÃ nh cÃ´ng láº§n nÃ y
   - alreadyCheckedIn: sá»‘ vÃ© Ä‘Ã£ check-in trÆ°á»›c Ä‘Ã³

2. ALREADY CHECKED-IN TICKETS:
   - VÃ© Ä‘Ã£ check-in sáº½ cÃ³ status = "already_checked_in"
   - CÃ³ thÃ´ng tin previousCheckIn vá»›i:
     * Thá»i gian check-in trÆ°á»›c
     * NgÆ°á»i check-in trÆ°á»›c  
     * PhÆ°Æ¡ng thá»©c check-in trÆ°á»›c (QR/Face/Other)
   - Message sáº½ hiá»ƒn thá»‹ chi tiáº¿t: "ticket QR004 already checked in at 2024-12-19 14:30 by Tráº§n Thá»‹ B via QrCode"

3. AI SERVICE INTEGRATION:
   - API gá»i Ä‘áº¿n AI service Ä‘á»ƒ nháº­n diá»‡n khuÃ´n máº·t
   - AI service tráº£ vá» OrderId náº¿u nháº­n diá»‡n thÃ nh cÃ´ng
   - Timeout: 30 giÃ¢y cho má»—i request Ä‘áº¿n AI
   - Náº¿u AI service khÃ´ng pháº£n há»“i: "AI service not responding"

4. FACE RECOGNITION FLOW:
   Step 1: Upload áº£nh Ä‘áº¿n AI service kÃ¨m EventId
   Step 2: AI service nháº­n diá»‡n vÃ  tráº£ vá» OrderId
   Step 3: Check-in táº¥t cáº£ vÃ© trong OrderId cho EventId Ä‘Ã³
   Step 4: Tráº£ vá» káº¿t quáº£ chi tiáº¿t tá»«ng vÃ©

5. ERROR HANDLING STRATEGY:
   - LuÃ´n check success flag trÆ°á»›c khi xá»­ lÃ½ data
   - Parse error message Ä‘á»ƒ hiá»ƒn thá»‹ thÃ´ng bÃ¡o phÃ¹ há»£p
   - Retry logic cho AI service timeout (tÃ¹y chá»n)
   - Fallback vá» QR code náº¿u face recognition tháº¥t báº¡i

ðŸ“± MOBILE IMPLEMENTATION GUIDE
==============================

1. FORM DATA PREPARATION:
```javascript
const formData = new FormData();
formData.append('EventId', eventId);
formData.append('FaceImage', {
    uri: imageUri,
    type: 'image/jpeg',
    name: 'face.jpg'
});
```

2. API CALL EXAMPLE:
```javascript
const checkInByFace = async (eventId, imageUri, accessToken) => {
    try {
        const formData = new FormData();
        formData.append('EventId', eventId);
        formData.append('FaceImage', {
            uri: imageUri,
            type: 'image/jpeg', 
            name: 'face.jpg'
        });

        const response = await fetch('/api/tickets/checkinbyface', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
            },
            body: formData
        });

        const result = await response.json();
        
        if (result.success) {
            // Handle successful check-in
            const { data } = result;
            console.log(`Successfully checked in ${data.successfulCheckins}/${data.totalTickets} tickets`);
            
            // Process each ticket detail
            data.checkinDetails.forEach(ticket => {
                if (ticket.status === 'success') {
                    console.log(`âœ… ${ticket.ticketCode}: Check-in successful`);
                } else if (ticket.status === 'already_checked_in') {
                    console.log(`âš ï¸ ${ticket.ticketCode}: Already checked in`);
                } else {
                    console.log(`âŒ ${ticket.ticketCode}: Check-in failed`);
                }
            });
        } else {
            // Handle error
            console.error('Check-in failed:', result.message);
        }
    } catch (error) {
        console.error('Network error:', error);
    }
};
```

3. IMAGE VALIDATION:
```javascript
const validateImage = (imageUri, fileSize) => {
    // Check file size (5MB limit)
    if (fileSize > 5 * 1024 * 1024) {
        throw new Error('Image must be smaller than 5MB');
    }
    
    // Check file extension
    const validExtensions = ['.jpg', '.jpeg', '.png'];
    const isValidType = validExtensions.some(ext => 
        imageUri.toLowerCase().endsWith(ext)
    );
    
    if (!isValidType) {
        throw new Error('Only JPG, JPEG, or PNG files are allowed');
    }
};
```

4. RESPONSE HANDLING:
```javascript
const handleCheckInResponse = (response) => {
    if (!response.success) {
        // Handle different error types
        switch (response.message) {
            case 'Face not recognized for this event':
                showAlert('KhÃ´ng nháº­n diá»‡n Ä‘Æ°á»£c khuÃ´n máº·t cho sá»± kiá»‡n nÃ y');
                break;
            case 'AI service not responding':
                showAlert('Dá»‹ch vá»¥ nháº­n diá»‡n Ä‘ang báº­n, vui lÃ²ng thá»­ láº¡i');
                break;
            case 'Only accept JPG, JPEG or PNG':
                showAlert('Chá»‰ cháº¥p nháº­n file JPG, JPEG hoáº·c PNG');
                break;
            default:
                showAlert(response.message);
        }
        return;
    }

    const { data } = response;
    
    // Show summary
    showAlert(`Check-in hoÃ n táº¥t: ${data.successfulCheckins}/${data.totalTickets} vÃ© thÃ nh cÃ´ng`);
    
    // Show details for each ticket
    data.checkinDetails.forEach(ticket => {
        if (ticket.status === 'already_checked_in') {
            const previousInfo = ticket.previousCheckIn;
            const time = new Date(previousInfo.checkedInAt).toLocaleString();
            showTicketAlert(
                `VÃ© ${ticket.ticketCode} Ä‘Ã£ Ä‘Æ°á»£c check-in vÃ o ${time} bá»Ÿi ${previousInfo.checkerName}`
            );
        }
    });
};
```

ðŸŽ¯ TESTING SCENARIOS
====================

1. NORMAL SUCCESS CASE:
   - Upload áº£nh khÃ¡ch hÃ ng cÃ³ vÃ© há»£p lá»‡
   - Expect: Táº¥t cáº£ vÃ© check-in thÃ nh cÃ´ng

2. PARTIAL SUCCESS CASE:
   - Upload áº£nh khÃ¡ch hÃ ng cÃ³ 5 vÃ©, 2 vÃ© Ä‘Ã£ check-in trÆ°á»›c
   - Expect: 3 vÃ© check-in thÃ nh cÃ´ng, 2 vÃ© status "already_checked_in"

3. NO FACE RECOGNITION:
   - Upload áº£nh khÃ´ng nháº­n diá»‡n Ä‘Æ°á»£c
   - Expect: "Face not recognized for this event"

4. INVALID IMAGE:
   - Upload file khÃ´ng pháº£i áº£nh
   - Expect: "Only accept JPG, JPEG or PNG"

5. IMAGE TOO LARGE:
   - Upload áº£nh > 5MB
   - Expect: "Must smaller than 5MB"

6. NO TICKETS FOR EVENT:
   - Upload áº£nh khÃ¡ch hÃ ng cÃ³ vÃ© nhÆ°ng khÃ´ng cho event nÃ y
   - Expect: "No tickets found for this event in the order"

ðŸ“ž SUPPORT & TROUBLESHOOTING
===========================

Common Issues:
1. AI Service Timeout â†’ Retry hoáº·c fallback QR code
2. Face Not Recognized â†’ HÆ°á»›ng dáº«n khÃ¡ch chá»¥p áº£nh rÃµ hÆ¡n
3. Already Checked In â†’ Hiá»ƒn thá»‹ thÃ´ng tin check-in trÆ°á»›c Ä‘Ã³
4. Network Issues â†’ Implement retry logic

Contact Backend Team náº¿u gáº·p:
- Lá»—i 500 Internal Server Error
- Response format khÃ´ng Ä‘Ãºng spec
- Authentication issues

===============================================================================
                              END OF DOCUMENTATION
=============================================================================== 